{% extends 'base.html' %}
{% load static %}

{% block title %}Transactions - FinFlow{% endblock %}
{% block page_title %}Transactions{% endblock %}

{% block content %}
<div class="mb-4 md:mb-6">
    <div class="flex flex-col gap-4 items-stretch md:items-center md:justify-between mb-4 md:mb-6">
        <div class="flex-1 flex flex-col md:flex-row gap-2 md:gap-3 w-full">
            <form method="GET" class="flex flex-col md:flex-row gap-2 md:gap-3 w-full">
                <input type="text" name="search" value="{{ search }}" placeholder="Search..." class="flex-1 px-3 md:px-4 py-2 text-sm border border-custom-border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-accent">
                
                <select name="type" class="px-3 md:px-4 py-2 text-sm border border-custom-border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-accent">
                    <option value="">All Types</option>
                    <option value="income" {% if selected_type == 'income' %}selected{% endif %}>Income</option>
                    <option value="expense" {% if selected_type == 'expense' %}selected{% endif %}>Expense</option>
                </select>

                <select name="category" class="px-3 md:px-4 py-2 text-sm border border-custom-border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-accent">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if selected_category|add:'' == category.id|stringformat:'d' %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>

                <button type="submit" class="px-3 md:px-4 py-2 text-sm bg-blue-800 text-custom-accent-foreground rounded-lg hover:bg-custom-accent/90 transition-colors whitespace-nowrap">
                    Filter
                </button>
            </form>
        </div>
        <button class="px-3 md:px-4 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors whitespace-nowrap w-full md:w-auto" onclick="showAddTransactionModal()">
            + Add Transaction
        </button>
    </div>
</div>

<div class="bg-custom-card border border-custom-border rounded-lg overflow-x-auto">
    <table class="w-full text-sm">
        <thead class="bg-custom-muted border-b border-custom-border">
            <tr>
                <th class="px-3 md:px-6 py-3 text-left text-xs md:text-sm font-semibold">Date</th>
                <th class="px-3 md:px-6 py-3 text-left text-xs md:text-sm font-semibold">Description</th>
                <th class="hidden sm:table-cell px-3 md:px-6 py-3 text-left text-xs md:text-sm font-semibold">Category</th>
                <th class="hidden md:table-cell px-3 md:px-6 py-3 text-left text-xs md:text-sm font-semibold">Type</th>
                <th class="px-3 md:px-6 py-3 text-right text-xs md:text-sm font-semibold">Amount</th>
                <th class="px-3 md:px-6 py-3 text-center text-xs md:text-sm font-semibold">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-border">
            {% for transaction in transactions %}
            <tr class="hover:bg-custom-muted/50 transition-colors">
                <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">{{ transaction.date }}</td>
                <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">{{ transaction.description }}</td>
                <td class="hidden sm:table-cell px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">{{ transaction.category.name }}</td>
                <td class="hidden md:table-cell px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">
                    <span class="inline-flex items-center px-2 py-2 rounded-xl text-xs font-medium {% if transaction.transaction_type == 'income' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                        {{ transaction.get_transaction_type_display }}
                    </span>
                </td>
                <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-semibold text-right {% if transaction.transaction_type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                    {% if transaction.transaction_type == 'income' %}+ {% else %}- {% endif %}Ksh {{ transaction.amount|floatformat:2 }}
                </td>
                <td class="px-3 md:px-6 py-3 md:py-4 text-center">
                    <div class="flex items-center justify-center gap-1 md:gap-2">
                        <button class="text-custom-accent hover:underline text-xs md:text-sm" onclick="editTransaction({{ transaction.id }})">Edit</button>
                        <form method="POST" action="{% url 'finflow:delete_transaction' transaction.id %}" style="display:inline;" onsubmit="return confirm('Are you sure?')">
                            {% csrf_token %}
                            <button type="submit" class="text-custom-destructive hover:underline text-xs md:text-sm">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="px-4 md:px-6 py-6 md:py-8 text-center text-xs md:text-sm text-custom-muted-foreground">
                    No transactions found
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Transaction Modal -->
<div id="addTransactionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-custom-card rounded-lg p-4 md:p-6 w-full max-w-md shadow-xl max-h-screen overflow-y-auto">
        <h3 class="text-lg md:text-xl font-semibold mb-4">Add Transaction</h3>
        
        <form id="transactionForm" method="POST" action="{% url 'finflow:add_transaction' %}" class="space-y-4">
            {% csrf_token %}

            <div>
                <label class="block text-sm font-medium mb-2">Type</label>
                <select name="type" required class="w-full px-3 md:px-4 py-2 text-sm border border-custom-border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-accent" onchange="updateCategories()">
                    <option value="">Select type</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Category</label>
                <select name="category" required class="w-full px-3 md:px-4 py-2 text-sm border border-custom-border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-accent">
                    <option value="">Select category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" data-type="{{ category.category_type }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Description</label>
                <input type="text" name="description" required class="w-full px-3 md:px-4 py-2 text-sm border border-custom-border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-accent" placeholder="Enter description">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Date</label>
                <input type="date" name="date" required class="w-full px-3 md:px-4 py-2 text-sm border border-custom-border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-accent">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Amount</label>
                <input type="number" name="amount" step="0.01" min="0" required class="w-full px-3 md:px-4 py-2 text-sm border border-custom-border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-accent" placeholder="0.00">
            </div>

            <div class="flex flex-col sm:flex-row gap-3 pt-4">
                <button type="button" onclick="closeAddTransactionModal()" class="flex-1 px-4 py-2 text-sm border border-custom-border rounded-lg hover:bg-custom-muted transition-colors">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-2 text-sm bg-custom-accent text-custom-accent-foreground rounded-lg hover:bg-custom-accent/90 transition-colors">
                    Add
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function showAddTransactionModal() {
        document.getElementById('addTransactionModal').classList.remove('hidden');
    }

    function closeAddTransactionModal() {
        document.getElementById('addTransactionModal').classList.add('hidden');
    }

    function updateCategories() {
        const typeSelect = document.querySelector('select[name="type"]');
        const categorySelect = document.querySelector('select[name="category"]');
        const selectedType = typeSelect.value;
        
        Array.from(categorySelect.options).forEach(option => {
            if (option.dataset.type && option.dataset.type !== selectedType) {
                option.style.display = 'none';
            } else if (option.dataset.type) {
                option.style.display = 'block';
            }
        });
    }

    function editTransaction(id) {
        alert('Edit transaction ' + id + ' - implement as needed');
    }

    // Close modal when clicking outside
    document.getElementById('addTransactionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddTransactionModal();
        }
    });
</script>
{% endblock %}
